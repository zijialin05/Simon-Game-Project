#include <xc.inc>
	
global	DAC_Setup, DAC_Int_Hi
psect	udata_acs
counter:    ds	1

psect	udata_bank4
myArray:    ds	0x80

psect	data

myTable:
	db  0x80, 0x86, 0x8c, 0x92, 0x98, 0x9e, 0xa5, 0xaa
	db  0xb0, 0xb6, 0xbc, 0xc1, 0xc6, 0xcb, 0xd0, 0xd5
	db  0xda, 0xde, 0xe2, 0xe6, 0xea, 0xed, 0xf0, 0xf3
	db  0xf5, 0xf8, 0xfa, 0xfb, 0xfd, 0xfe, 0xfe, 0xff
	db  0xff, 0xff, 0xfe, 0xfe, 0xfd, 0xfb, 0xfa, 0xf8
	db  0xf5, 0xf3, 0xf0, 0xed, 0xea, 0xe6, 0xe2, 0xde
	db  0xda, 0xd5, 0xd0, 0xcb, 0xc6, 0xc1, 0xbc, 0xb6
	db  0xb0, 0xaa, 0xa5, 0x9e, 0x98, 0x92, 0x8c, 0x86
	db  0x80, 0x79, 0x73, 0x6d, 0x67, 0x61, 0x5a, 0x55
	db  0x4f, 0x49, 0x43, 0x3e, 0x39, 0x34, 0x2f, 0x2a
	db  0x25, 0x21, 0x1d, 0x19, 0x15, 0x12, 0x0f, 0x0c
	db  0x0a, 0x07, 0x05, 0x04, 0x02, 0x01, 0x01, 0x00
	db  0x00, 0x00, 0x01, 0x01, 0x02, 0x04, 0x05, 0x07
	db  0x0a, 0x0c, 0x0f, 0x12, 0x15, 0x19, 0x1d, 0x21
	db  0x25, 0x2a, 0x2f, 0x34, 0x39, 0x3e, 0x43, 0x49
	db  0x4f, 0x55, 0x5a, 0x61, 0x67, 0x6d, 0x73, 0x79
	
	myTable_1    EQU	128
	align	2
	
psect	dac_code, class=CODE
	
DAC_Int_Hi:	
	btfss	TMR0IF		; check that this is timer0 interrupt
	retfie	f		; if not then return
	;incf	LATJ, F, A	; increment PORTD
	movlw	0x00
	movwf	LATH
	tblrd*+
	movff	TABLAT, PORTJ
	movlw	0xFF
	movwf	LATH
	decfsz	counter, A
	movf	counter, W, A
	btfsc	STATUS, 2
	call	RST
	bcf	TMR0IF		; clear interrupt flag
	movlw	0xFF
	movwf	TMR0L, A
	movlw	0xF0
	movwf	TMR0H, A
	bsf	TMR0IE		; Enable timer0 interrupt
	retfie	f		; fast return from interrupt

DAC_Setup:
	clrf	TRISJ, A	; Set PORTD as all outputs
	clrf	TRISH, A
	clrf	LATJ, A		; Clear PORTD outputs
	movlw	0xFF
	movwf	LATH, A
	movlw	10000111B	; Set timer0 to 16-bit, Fosc/4/256
	movwf	T0CON, A	; = 62.5KHz clock rate, approx 1sec rollover
	bsf	TMR0IE		; Enable timer0 interrupt
	bsf	GIE		; Enable all interrupts
	bcf	CFGS
	bsf	EEPGD
	lfsr	0, myArray
	movlw	low highword(myTable)
	movwf	TBLPTRU, A
	movlw	high(myTable)
	movwf	TBLPTRH, A
	movlw	low(myTable)
	movwf	TBLPTRL, A
	movlw	myTable_1
	movwf	counter, A
	
	return
	
RST:
	lfsr	0, myArray
	movlw	low highword(myTable)
	movwf	TBLPTRU, A
	movlw	high(myTable)
	movwf	TBLPTRH, A
	movlw	low(myTable)
	movwf	TBLPTRL, A
	movlw	myTable_1
	movwf	counter, A
	return
	end

